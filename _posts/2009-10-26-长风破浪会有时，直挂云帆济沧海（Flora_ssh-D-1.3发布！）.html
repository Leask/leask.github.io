---
layout: post
status: publish
published: true
title: "长风破浪会有时，直挂云帆济沧海（Flora_ssh-D 1.3发布！）"
author: Leask




author_login: leask
author_email: i@leaskh.com
author_url: https://leaskh.com
wordpress_id: 57
wordpress_url: http://leaskh.wordpress.com/2009/10/26/%e9%95%bf%e9%a3%8e%e7%a0%b4%e6%b5%aa%e4%bc%9a%e6%9c%89%e6%97%b6%ef%bc%8c%e7%9b%b4%e6%8c%82%e4%ba%91%e5%b8%86%e6%b5%8e%e6%b2%a7%e6%b5%b7%ef%bc%88flora_ssh-d-1-3%e5%8f%91%e5%b8%83%ef%bc%81%ef%bc%89
date: '2009-10-26 01:47:08 +0800'
date_gmt: '2009-10-26 01:47:08 +0800'
categories:

tags: []
comments: []
---
<div id="msgcns!15BAC1A170471DB!15074" class="bvMsg">
<p>Flora_ssh-D 1.3 版本发布！
<ol>
<li>本版本重新整理程序，实现模块化；</li>
<li>引入后台运行机制，时刻检查网络；</li>
<li>简化设定，功能设置只需要留空，该功能就不会执行了；</li>
<li>直接使用DNS-O-MATIC的API更新动态IP，不再需要额外的程序了。</li></ol>
<p>不推荐升级这个版本，因为1.73版本已经开发出来了，我下一文就是发布1.73的，先发1.3是因为想保持版本的连续性。大家可以忽略。</p>
<p>Google Code上的下载地址为：<a title="http://code.google.com/p/flora-ssh-d/downloads/list" href="http://code.google.com/p/flora-ssh-d/downloads/list" target="_blank">http://code.google.com/p/flora-ssh-d/downloads/list</a> （包含源代码）</p>
<p>代码如下：</p><br />
<blockquote>
<p>(* Flora_ssh-D // Version 1.3 // Code by Leask Huang // www.leaskh.com // i@leaskh.com *)
<p>(* ======= Variable Declaration ======= *)<br />global timeTry<br />global DNSResponse<br />global isOLast
<p>(* ======= General Settings ======= *)<br />(* Custom these before you run this script *)
<p>set SSHServerName to "*******" -- Set ServerName, You must set this<br />set SSHUserName to "*******" -- Set UserName, You must set this<br />set SSHPasswd to "*******" -- Set Password, You must set this<br />set TwitterUsername to "*******" -- If you don't want to update Twitter status, leave it blank<br />set TwitterPassword to "*******" -- same as above<br />set TwitterText to "@" &amp; TwitterUsername &amp; " is online now! // " &amp; (current date) -- same as above<br />set DNSUsername to "*******"<br />set DNSPassword to "*******"<br />set appStList to &#123;"Adium", "CoverSutra", "Google Notifier"&#125; -- these aplications will launch while you are online (or leave it blank)<br />set appQuitList to &#123;"CoverSutra", "Google Notifier"&#125; -- these aplications will quit while you are offline (or leave it blank)
<p>(* ======= Advanced Settings ======= *)<br />(* You don't need to change these normally *)
<p>(* ======= Main Script ======= *)<br />set isOLast to ""
<p>repeat<br />&nbsp;&nbsp;&nbsp; delay 10000<br />end repeat<br />repeat<br />&nbsp;&nbsp;&nbsp; if fnCheckNet() is true then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if isOLast is not "online" then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnSSHCnt()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnAppStart()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnDNSUpdate()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnTwitter()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set isOLast to "online"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "All done!"<br />&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if isOLast is not "offline" then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnAppQuit()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set isOLast to "offline"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "All done!"<br />&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp; -- delay 333<br />&nbsp;&nbsp;&nbsp; delay 60<br />end repeat
<p>(* ======= Functions ======= *)<br />to fnCheckNet()<br />&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do shell script "curl --connect-timeout 7 apple.com/favicon.ico"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if isOLast is not "online" then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Great! You are online."<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true<br />&nbsp;&nbsp;&nbsp; on error<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if isOLast is not "offline" then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Opps! You are offline."<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false<br />&nbsp;&nbsp;&nbsp; end try<br />end fnCheckNet
<p>to fnCheckSSHD()<br />&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do shell script "curl --socks5 127.0.0.1:7070 --connect-timeout 7 apple.com/favicon.ico"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "OK! SSH D has been successfully connected."<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true<br />&nbsp;&nbsp;&nbsp; on error<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if timeTry > 0 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Opps! SSH D connection failed."<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false<br />&nbsp;&nbsp;&nbsp; end try<br />end fnCheckSSHD
<p>to fnAppStart()<br />&nbsp;&nbsp;&nbsp; if (count appStList) > 0 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Start Applications"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; repeat with intSti from 1 to (count appStList)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tell application (item intSti of appStList)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; activate<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end tell<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end repeat<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; on error<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Opps! Error."<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end try<br />&nbsp;&nbsp;&nbsp; end if<br />end fnAppStart
<p>to fnAppQuit()<br />&nbsp;&nbsp;&nbsp; if (count appQuitList) > 0 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Quit Applications"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; repeat with intSti from 1 to count appQuitList<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tell application (item intSti of appQuitList)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; quit<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end tell<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end repeat<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; on error<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Opps! Error."<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end try<br />&nbsp;&nbsp;&nbsp; end if<br />end fnAppQuit
<p>to fnSSHCnt()<br />&nbsp;&nbsp;&nbsp; if (length of SSHServerName) > 0 and (length of SSHUserName) > 0 and (length of SSHPasswd) > 0 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set timeTry to 0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Create SSH D connection"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; repeat while fnCheckSSHD() is false<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if timeTry > 0 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (button returned of (display dialog "Opps! ssh -D connection failed. Do you want to retry?" &amp; return &amp; "" buttons &#123;"Retry", "Quit"&#125;)) is "Quit" then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exit repeat<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnShellSSH()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set timeTry to timeTry + 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end repeat<br />&nbsp;&nbsp;&nbsp; end if<br />end fnSSHCnt
<p>to fnShellSSH()<br />&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tell application "Terminal"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; quit<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; activate<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do script "rm ~/Downloads/.Flora_ssh-D.out" in window 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do script "killall ssh" in window 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do script "killall ssh-agent" in window 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do script "nohup ssh -D 7070 " &amp; SSHUserName &amp; "@" &amp; SSHServerName &amp; " > Downloads/.Flora_ssh-D.out" in window 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end tell<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "SSH D connection request and log in request have been sent. Waiting for response from remote server."<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tell application "Terminal"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do script SSHPasswd in window 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; quit<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end tell<br />&nbsp;&nbsp;&nbsp; on error<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Opps! Error."<br />&nbsp;&nbsp;&nbsp; end try<br />end fnShellSSH
<p>to fnTwitter()<br />&nbsp;&nbsp;&nbsp; if (length of TwitterUsername) > 0 and (length of TwitterPassword) > 0 and (length of TwitterText) > 0 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Update Twitter state"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do shell script "curl --user " &amp; (quoted form of (TwitterUsername &amp; ":" &amp; TwitterPassword)) &amp; " --data-binary " &amp; (quoted form of ("status=" &amp; TwitterText)) &amp; " <a href="https://twitter.com/statuses/update.json"">https://twitter.com/statuses/update.json"</a><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "OK! Twitter state has been successfully updated."<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; on error<br<br />
 />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Opps! Error."<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end try<br />&nbsp;&nbsp;&nbsp; end if<br />end fnTwitter
<p>to fnDNSShell()<br />&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set DNSResponse to (do shell script "curl <a href="https://"">https://"</a> &amp; DNSUsername &amp; ":" &amp; DNSPassword &amp; "@updates.dnsomatic.com/nic/update?&amp;wildcard=NOCHG&amp;mx=NOCHG&amp;backmx=NOCHG")<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if first word of DNSResponse is "good" then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp; on error<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false<br />&nbsp;&nbsp;&nbsp; end try<br />end fnDNSShell
<p>to fnDNSUpdate()<br />&nbsp;&nbsp;&nbsp; if (length of DNSUsername) > 0 and (length of DNSPassword) > 0 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Update dynamic IP"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if fnDNSShell() is true then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "OK! Dynamic IP has been successfully updated to " &amp; (second word of DNSResponse)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Opps! Error."<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp; end if<br />end fnDNSUpdate</p></blockquote>  </div></p>
