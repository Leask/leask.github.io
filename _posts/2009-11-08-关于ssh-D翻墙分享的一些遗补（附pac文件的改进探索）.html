---
layout: post
status: publish
published: true
title: "关于ssh -D翻墙分享的一些遗补（附pac文件的改进探索）"
author: Leask




author_login: leask
author_email: i@leaskh.com
author_url: https://leaskh.com
wordpress_id: 51
wordpress_url: http://leaskh.wordpress.com/2009/11/08/%e5%85%b3%e4%ba%8essh-d%e7%bf%bb%e5%a2%99%e5%88%86%e4%ba%ab%e7%9a%84%e4%b8%80%e4%ba%9b%e9%81%97%e8%a1%a5%ef%bc%88%e9%99%84pac%e6%96%87%e4%bb%b6%e7%9a%84%e6%94%b9%e8%bf%9b%e6%8e%a2%e7%b4%a2%ef%bc%89
date: '2009-11-08 06:19:23 +0800'
date_gmt: '2009-11-08 06:19:23 +0800'
categories:

tags: []
comments:
- id: 357
  author: "峰"
  author_email: ''
  author_url: ''
  date: '2010-01-27 12:08:19 +0800'
  date_gmt: '2010-01-27 12:08:19 +0800'
  content: Leask.h 你好！想请教个问题我经常在几个不同的代理之间切换，有时 ssh 有时 tor 或别的，总得去修改 pac 文件。想加一个判断，当
    ssh 可用时，使用 SOCKS 127.0.0.1:7070，当 tor 可用时使用 PROXY 127.0.0.1:8118 ，这个可以实现吗。对程序语言一窍不通，期待你的帮助！
---
<div id="msgcns!15BAC1A170471DB!15093" class="bvMsg">
<p>我曾在过去的文章中提到过，由于购买的商业ssh服务器大多数只允许一个用户在一个机器上登录，因此如果你家里有超过2个电脑需要翻墙，又或者你的iPhone或者iPod touch、PSP等和你的电脑位于同一个无线路由器下，你希望你的设备同样能分享主机的ssh -D连接。</p>
<p>前文中我写到可以把代理服务器指向你已经创建ssh -D代理的主机，这样做在我的VM虚拟机里面是能够分享到宿主机Mac上的ssh -D连接。但是上个星期我购买了一款叫做Simplenote的软件，正当我想要同步Mac上的笔记到iPod touch上的时候发现同步失败。经过研究发现Simplenote同步需要连接Google appspot服务器，然而appspot在我所在的区域已经被&ldquo;墙歼&rdquo;了，于是我尝试在iPod touch上分享我Mac上的ssh -D连接，意外地失败了。测试手上的P1i通过wifi分享来自Mac上的ssh -D连接，同样失败。经过一番折腾，发现原来ssh -D默认是不响应来自远程主机发起的连接的，如果确实需要分享，你需要在ssh -D后面再加上一个-g的参数，如：</p><br />
<blockquote>
<p><em>ssh -D 7070 <strong><font color="#ff8040">-g</font></strong> </em><a href="mailto:username@ssh.yourdomain.com"><em>username@ssh.yourdomain.com</em></a></p></blockquote>
<p>用这个参数创建的连接能够顺利把ssh -D的代理分享出去，当然了，你可能还会遇到pac文件的烦恼，毕竟每个人所要求翻墙访问的站点都不同。下面我分享一下我的pac文件的写法：</p><br />
<blockquote>
<p><em>// Flora AntiGFW PAC<br />// Version 5.0<br />// by LeaskH.com<br />// i@leaskh.com </em>
<p><em>function FindProxyForURL(url, host)<br />&#123;<br />&nbsp;&nbsp;&nbsp; // AntiGFW<br />&nbsp;&nbsp;&nbsp; var arrStrGFWSites = [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "appspot.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "honeonet.spaces.live.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "blogger.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "blogspot.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "w3schools.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "box.net",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "bit.ly",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "j.mp",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "vimeo.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "mediafire.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "wordpress.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "tistory.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "aol.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "aim.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "bebo.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "cnn.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "hellotxt.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "dougscripts.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "iphone-dev.org",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "dailymotion.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "yylyyl.co.cc",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "googlevideo.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "imageshack.us",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "cafepress.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "twitterfeed.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "hotspotshield.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "youtube.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "twitpic.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "mckaywei.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "mimima.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "no-ip.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "oikos.com.tw",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "////",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ytimg.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "sesawe.net",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "freemorenews.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "theappleblog.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "chinagfw.org",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "chinadigitaltimes.net",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "dropbox.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "facebook.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "s.leaskh.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "sites.weborigin.co.nz",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "docs.weborigin.co.nz",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "calendar.weborigin.co.nz",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "google.com/search?*twitter",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "google.com/search?*@",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "google.com/search?*youtube",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "sites.leaskh.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "docs.leaskh.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "openvpn.net",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "simplenoteapp.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "code.leaskh.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "moderator.leaskh.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "calendar.leaskh.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "mail.weborigin.co.nz",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "mail.leaskh.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "yfrog.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "viewmorepics.myspace.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "messaging.myspace.com",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "</em><a href="http://*twitter.com""><em>http://*twitter.com"</em></a><br /><em>&nbsp;&nbsp;&nbsp; ];<br />&nbsp;&nbsp;&nbsp; // Block unsafe sites<br />&nbsp;&nbsp;&nbsp; var arrStrUNSSites = ["74.55.154.140"];<br />&nbsp;&nbsp;&nbsp; var strActProxy = "DIRECT";<br />&nbsp;&nbsp;&nbsp; for(var iAS = 0; iAS < arrStrGFWSites.length; iAS++)<br />&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(shExpMatch(url.toLowerCase(), "*" + arrStrGFWSites[iAS].toLowerCase() + "*"))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; switch (myIpAddress())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;</em></p>
<p><em>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // When I using Virtual Machine<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case "172.16.49.133":&nbsp;&nbsp; // My Virtual Machine&rsquo;s IP</em><em><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strActProxy = "PROXY 127.0.0.1:8118";&nbsp;&nbsp; // My Privoxy Proxy on VM shared from Mac&rsquo;s ssh -D<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br /></em><em>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // When I using iPod touch<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case "10.0.1.253":&nbsp;&nbsp; // My iPod touch&rsquo;s IP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strActProxy = "SOCKS 10.0.1.254:7070";&nbsp; // My iPod touch can visit my My by this IP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br /></em><em>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // When I using Mac<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strActProxy = "SOCKS 127.0.0.1:7070";&nbsp; // My real ssh &ndash;D<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;;<br />&nbsp;&nbsp;&nbsp; &#125;;<br />&nbsp;&nbsp;&nbsp; for(var iAS = 0; iAS < arrStrUNSSites.length; iAS++)<br />&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(shExpMatch(url.toLowerCase(), "*" + arrStrUNSSites[iAS].toLowerCase() + "*"))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#123;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strActProxy = "PROXY honeonet.spaces.live.com";&nbsp; // Input a site which is already blocked by GFW<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#125;;<br />&nbsp;&nbsp;&nbsp; &#125;;<br />&nbsp;&nbsp;&nbsp; return strActProxy;<br />&#125;;</em></p></blockquote>
<p>以上就是我的pac脚本，应该说用pac分配代理服务器是非常便利和强大的。pac配合ssh -D简直就是&ldquo;奔向自由&rdquo;的两件神器。我的pac主要有如下特点：
<ol>
<li>通过单独一个pac文件，管理你所有设备的代理服务器，不再需要为每个不同的设备配置不同的pac文件了；</li>
<li>把Twitter的适配URL写为：<a href="http://*twitter.com""><em>http://*twitter.com</em></a>，区别于网上的写法，因为Twitter是能够通过<em>https</em>访问的（改host），当我们通过https访问的时候，我们不需要通过代理，对于Tiwtter重度使用者，这样能够节省下很大程度的ssh流量，这样写只有使用普通http协议访问的时候才会通过代理；</li>
<li>引入 <em>google.com/search?*twitter </em>的写法，就是当你的Google搜索关键字包含&ldquo;Twitter&rdquo;的时候，也通过代理访问Google，这个写法是很有用的，当然了根据实际用途，你要把&ldquo;Twitter&rdquo;改为你关心的，被和谐了的关键字哦，例如&ldquo;六四&rdquo;等等（不许联想）。</li>
<li>引入 //// 的写法，就是加入一个网站你突然访问不到，你可以在URL地址后面加////，然后再尝试打开，那么这个地址就<br />
会通过代理访问了，那就不需要每次都改pac文件才知道站点是不是被墙了，十分便利哦；</li>
<li>引入 google.com/search?*@ 的写法，由于Google出于私隐保护的需要，Email地址中的@符号是不会被Google索引的，所以@在搜索关键字中会被自动忽略，利用这一特性，我们在搜索一个敏感关键字的时候在关键字中插入一个@符号，那么就会自动通过代理访问Google了，由于Google会自动忽略@，所以并不会影响你的搜索结果，特别是在屏蔽比较多的图片搜索中，这个方法十分管用；</li>
<li>出于安全考虑，有一些站点虽然没有被墙但是我们是不愿意访问的，例如带有病毒的站点或者钓鱼站点等，这些站点也能够利用pac文件来屏蔽，因此，我的pac脚本中带有两个数组，第一个是用来分辨是否被gfw墙的站点的，这个数组叫做arrStrGFWSites，然而我还引入了另一个数组arrStrUNSSites，用来过滤不安全的站点，你把自己认为不安全的站点写在里面就行了，脚本将把这个URL指向一个被墙的站点，达到过滤的目的。</li></ol>
<p>本文的pac文件大家是不能直接用在自己的网络环境里的，写出来只是为了抛砖引玉，期待有喜欢折腾的高手写出更加智能的pac文件。</p>
<p>服务于生活，这正是编程的意义所在。今天就写到这里。</p>
<p>// 补充：如果你只需要在iPhone或者iPod touch上翻墙，那么由于iPhone OS基于Unix，是可以直接创建ssh链接的，只需要Cydia安装Openssh、Openssl和Mobile Terminal就可以了。基于Linux的设备也大同小异，例如Google的Android电话。</p>  </div></p>
