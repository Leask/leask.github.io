---
layout: post
status: publish
published: true
title: Flora_ssh-D Version 2.47发布！//主要修正：iTunes更新大量Podcast的时候脚本超时的Bug。
author: Leask




author_login: leask
author_email: i@leaskh.com
author_url: http://www.leaskh.com
wordpress_id: 47
wordpress_url: http://leaskh.wordpress.com/2009/11/16/flora_ssh-d-version-2-47%e5%8f%91%e5%b8%83%ef%bc%81%e4%b8%bb%e8%a6%81%e4%bf%ae%e6%ad%a3%ef%bc%9aitunes%e6%9b%b4%e6%96%b0%e5%a4%a7%e9%87%8fpodcast%e7%9a%84%e6%97%b6%e5%80%99%e8%84%9a%e6%9c%ac
date: '2009-11-16 10:27:18 +0800'
date_gmt: '2009-11-16 10:27:18 +0800'
categories:

tags: []
comments: []
---
<div id="msgcns!15BAC1A170471DB!15106" class="bvMsg">
<p>这个版本早就做好了，但是一直徘徊要不要放出来。因为这段时间我在尝试修改autossh的源代码。autossh是一个很优秀的开源项目，我希望build一个带有更完善翻墙功能的autossh版本，目前还是遇到很多问题。由于工作比较忙，可能一时三刻还完成不了，所以还是放出这个版本。这个版本对于一般的用户已经比较完美了，但是对于用Terminal比较多的用户，还是会有一点不适应的，因为脚本中连接ssh的时候会独占Terminal，这个问题我暂时还没有比较好的解决办法。</p>
<p>另外为了提高安全性，我尝试把各种用户名和密码保存在Mac的Keychain里面，但是不知道是不是因为Mac OS X 10.6.x中比较烦人的脚本安全规则作怪，脚本每次访问Keychain都需要弹出对话框让用户确认，所以最终还是放弃了这个做法，希望有解决办法的朋友指教一下。</p>
<p><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="Screen shot 2009-10-28 at 8.33.53 PM" border="0" alt="Screen shot 2009-10-28 at 8.33.53 PM" src="http://www.leaskh.com/wp-content/uploads/2010/09/screenshot2009-10-28at8.png?w=300" width="640" height="355" /><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="Screen shot 2009-10-28 at 8.34.34 PM" border="0" alt="Screen shot 2009-10-28 at 8.34.34 PM" src="http://www.leaskh.com/wp-content/uploads/2010/09/screenshot2009-10-28at81.png?w=300" width="614" height="427" />&nbsp;</p>
<p>好了，不多说，最后还是放出源代码（和往常一样，我将在Google Code放出封装好的app和源代码，有需要的朋友直接去下载更新吧）：</p><br />
<blockquote>
<p><em>(* Flora_ssh-D Version 2.47<br />Open Source Project Home/开源项目主页: </em><a href="http://code.google.com/p/flora-ssh-d/"><em>http://code.google.com/p/flora-ssh-d/</em></a><br /><em>Code by/程序编写: 黄思夏 / Leask Huang<br />Blog: </em><a href="http://www.leaskh.com"><em>http://www.leaskh.com</em></a><em> (天朝访问需翻墙)<br />E-mail/GTalk/MSN/QQ: i@leaskh.com *) </em></p>
<p><em>(* CUSTOM THESE SETTINGS BEFORE YOUR RUN THINS SCRIPT // 运行此脚本前请先配置此区域的参数<br />&nbsp;&nbsp;&nbsp; LEAVE IT BLANK IF YOU DON'T NEED IT // 如你不需要其中某些功能请将设置留空 *)<br />property SSHServerName : ""<br />property SSHUserName : ""<br />property SSHPasswd : ""<br />property TwitterUsername : ""<br />property TwitterPassword : ""<br />property DNSUsername : ""<br />property DNSPassword : ""<br />property LastfmUsername : ""<br />property LastfmPassword : ""<br />property appStList : &#123;&#125;<br />property appQuitList : &#123;&#125; </em>
<p><em>(* Example/示例 // English Help // 中文帮助 <br />property SSHServerName : "ssh.yourdomain.com"&nbsp;&nbsp; -- ssh -D Server Address (or leave it blank)&nbsp; //&nbsp; ssh -D 翻墙服务器地址 (不使用ssh -D则留空)<br />property SSHUserName : "*******"&nbsp;&nbsp; -- ssh -D User Name (or leave it blank)&nbsp; //&nbsp; ssh -D 帐号 (不使用ssh -D则留空)<br />property SSHPasswd : "*******"&nbsp;&nbsp; -- ssh -D Password (or leave it blank) //&nbsp; ssh -D 密码 (不使用ssh -D则留空)<br />property TwitterUsername : "*******"&nbsp;&nbsp; -- Twitter User Name (or leave it blank)&nbsp; //&nbsp; Twitter帐号 (不使用Twitter则留空)<br />property TwitterPassword : "*******"&nbsp;&nbsp; -- Twitter Password (or leave it blank)&nbsp; //&nbsp; Twitter密码 (不使用Twitter则留空)<br />property DNSUsername : "*******"&nbsp;&nbsp; -- DNS User Name (or leave it blank)&nbsp; //&nbsp; DNS-O-MATIC动态IP帐号 (不使用动态IP则留空)<br />property DNSPassword : "*******"&nbsp;&nbsp; -- DNS Password (or leave it blank)&nbsp; //&nbsp; DNS-O-MATIC动态IP密码 (不使用动态IP则留空)<br />property LastfmUsername : "*******"&nbsp;&nbsp; -- last.fm User Name (or leave it blank)&nbsp; // last.fm帐号 (不使用last.fm则留空)<br />property LastfmPassword : "*******"&nbsp;&nbsp; -- last.fm Password (or leave it blank)&nbsp; //&nbsp; last.fm密码 (不使用last.fm则留空)<br />property appStList : &#123;"App 1", "软件2","iChat"&#125;&nbsp;&nbsp; -- these apps will launch while you are online (or leave it blank)&nbsp; //&nbsp; 填写【在线】时需【开启】的软件(不使用此功能则留空)<br />property appQuitList : &#123;"App 1", "软件2","QQ"&#125;&nbsp;&nbsp; -- these apps will quit while you are offline (or leave it blank)&nbsp; //&nbsp; 填写【离线】时需【关闭】的软件(不使用此功能则留空)<br />*) </em>
<p><em>(* ======= Variable Declaration ======= *)<br />global timeTry<br />global DNSResponse<br />global isOLast<br />global iTsCurDBID<br />global iTsORSoundVolume<br />global strSNGArtist<br />global strSNGName<br />global strSNGAlbum<br />global strSNGTrackNumber<br />global strSNGDuration<br />global intIdleCount </em>
<p><em>(* ======= Main Script ======= *)<br />on run<br />&nbsp;&nbsp;&nbsp; set isOLast to ""<br />&nbsp;&nbsp;&nbsp; set iTsCurDBID to ""<br />&nbsp;&nbsp;&nbsp; set intIdleCount to 10<br />end run </em>
<p><em>on quit<br />&nbsp;&nbsp;&nbsp; with timeout of 3600 seconds<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if isOLast is "online" then fnTwitter("I am offline now! // " &amp; (current date), true)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnShellSSHEnd(true)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnAppQuit()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; continue quit<br />&nbsp;&nbsp;&nbsp; end timeout<br />end quit </em>
<p><em>on idle<br />&nbsp;&nbsp;&nbsp; with timeout of 3600 seconds<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if fnCheckNet() is true then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if intIdleCount > 9 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnSSHCnt()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if isOLast is not "online" then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnAppStart()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnDNSUpdate()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnTwitter("I am online now! // " &amp; (current date), true)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set intIdleCount to 0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnMusic(true)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set intIdleCount to intIdleCount + 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set isOLast to "online"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnMusic(false)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if isOLast is not "offline" then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnShellSSHEnd(true)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnAppQuit()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set isOLast to "offline"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp; end timeout<br />&nbsp;&nbsp;&nbsp; return 60<br />end idle </em>
<p><em>(* ======= Functions ======= *)<br />to fnCheckNet()<br />&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do shell script "curl --connect-timeout 30 "apple.com/favicon.ico""<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if isOLast is not "online" then SmartSay(&#123;"Online"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true<br />&nbsp;&nbsp;&nbsp; on error<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if isOLast is not "offline" then SmartSay(&#123;"Offline"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false<br />&nbsp;&nbsp;&nbsp; end try<br />end fnCheckNet </em>
<p><em>to fnAppStart()<br />&nbsp;&nbsp;&nbsp; if (count appStList) > 0 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SmartSay(&#123;"Start Apps"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; repeat with intSti from 1 to (count appStList)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tell application (item intSti of appStList) to activate<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end repeat<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SmartSay(&#123;"OK"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; on error<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SmartSay(&#123;"Failed"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end try<br />&nbsp;&nbsp;&nbsp; end if<br />end fnAppStart </em>
<p><em>to fnAppQuit()<br />&nbsp;&nbsp;&nbsp; if (count appQuitList) > 0 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SmartSay(&#123;"Quit Applications&quot<br />
;&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; repeat with intSti from 1 to count appQuitList<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tell application (item intSti of appQuitList) to quit<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end repeat<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SmartSay(&#123;"OK"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; on error<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SmartSay(&#123;"Failed"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end try<br />&nbsp;&nbsp;&nbsp; end if<br />end fnAppQuit </em>
<p><em>to fnSSHCnt()<br />&nbsp;&nbsp;&nbsp; if (length of SSHServerName) > 0 and (length of SSHUserName) > 0 and (length of SSHPasswd) > 0 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set timeTry to 0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; repeat while fnCheckSSHD() is false<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SmartSay(&#123;"Connect SSH D"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if timeTry > 0 then if (button returned of (display dialog "ssh -D connection failed." &amp; return &amp; "" buttons &#123;"Retry", "Ignore"&#125;)) is "Ignore" then exit repeat<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnShellSSH()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set timeTry to timeTry + 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end repeat<br />&nbsp;&nbsp;&nbsp; end if<br />end fnSSHCnt </em>
<p><em>to fnCheckSSHD()<br />&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do shell script "curl --socks5 127.0.0.1:7070 --connect-timeout 30 "apple.com/favicon.ico""<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if timeTry > 0 then SmartSay(&#123;"OK"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true<br />&nbsp;&nbsp;&nbsp; on error<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if timeTry > 0 then SmartSay(&#123;"Failed"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false<br />&nbsp;&nbsp;&nbsp; end try<br />end fnCheckSSHD </em>
<p><em>to fnShellSSH()<br />&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do shell script "killall Terminal"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tell application "Terminal"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; activate<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnShellSSHEnd(false) of me<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do script "nohup ssh -D 7070 " &amp; SSHUserName &amp; "@" &amp; SSHServerName &amp; " > Downloads/.Flora_ssh-D.out" in window 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end tell<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SmartSay(&#123;"SSH D connection request and log in request have been sent. Waiting for response from remote server."&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tell application "Terminal"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do script SSHPasswd in window 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; quit<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end tell<br />&nbsp;&nbsp;&nbsp; end try<br />end fnShellSSH </em>
<p><em>to fnShellSSHEnd(isSay)<br />&nbsp;&nbsp;&nbsp; if (length of SSHServerName) > 0 and (length of SSHUserName) > 0 and (length of SSHPasswd) > 0 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if isSay is true then SmartSay(&#123;"Disconnect SSH D"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do shell script "killall ssh"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do shell script "killall ssh-agent"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do shell script "rm ~/Downloads/.Flora_ssh-D.out"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end try<br />&nbsp;&nbsp;&nbsp; end if<br />end fnShellSSHEnd </em>
<p><em>to fnTwitter(strTwText, isSay)<br />&nbsp;&nbsp;&nbsp; if (length of TwitterUsername) > 0 and (length of TwitterPassword) > 0 and (length of strTwText) > 0 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (length of strTwText) > 140 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set strTwText to (characters 1 through 137 of strTwText as string) &amp; "..."<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if isSay is true then SmartSay(&#123;"Update Twitter state"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do shell script "curl --connect-timeout 30&nbsp; --user " &amp; (quoted form of (TwitterUsername &amp; ":" &amp; TwitterPassword)) &amp; " --data-binary " &amp; (quoted form of ("status=" &amp; strTwText)) &amp; " "</em><a href="https://twitter.com/statuses/update.json"""><em>https://twitter.com/statuses/update.json""</em></a><br /><em>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if isSay is true then SmartSay(&#123;"OK"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; on error<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if isSay is true then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SmartSay(&#123;"Failed"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SmartSay(&#123;"Update Twitter state failed"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end try<br />&nbsp;&nbsp;&nbsp; end if<br />end fnTwitter </em>
<p><em>to fnDNSShell()<br />&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set DNSResponse to (do shell script "curl --connect-timeout 30 "</em><a href="https://""><em>https://"</em></a><em> &amp; DNSUsername &amp; ":" &amp; DNSPassword &amp; "@updates.dnsomatic.com/nic/update?&amp;wildcard=NOCHG&amp;mx=NOCHG&amp;backmx=NOCHG"")<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if first word of DNSResponse is "good" then -- (second word of DNSResponse) is IP address<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp; on error<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false<br />&nbsp;&nbsp;&nbsp; end try<br />end fnDNSShell </em>
<p><em>to fnDNSUpdate()<br />&nbsp;&nbsp;&nbsp; if (length of DNSUsername) > 0 and (length of DNSPassword) > 0 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SmartSay(&#123;"Update dynamic IP"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if fnDNSShell() is true then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SmartSay(&#123;"OK"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SmartSay(&#123;"Failed"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp; end if<br />end fnDNSUpdate </em>
<p><em>to fnURLec(strToUEC)<br />&nbsp;&nbsp;&nbsp; return do shell script "python -c 'import sys, urllib; print urllib.quote(sys.argv[1])' "" &amp; strToUEC &amp; """<br />end fnURLec </em>
<p><em>to fniTunesisActive()<br />&nbsp;&nbsp;&nbsp; tell application "System Events" to return (name of processes contains "iTunes")<br />end fniTunesisActive </em>
<p><em>to fuisiTunesNUD()<br />&nbsp;&nbsp;&nbsp; if fniTunesisActive() is true then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tell application "iTunes"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if player state is playing then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set iTsNewDBID to (get database ID of current track)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if iTsNewDBID is not iTsCurDBID then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set strSNGArtist to (get artist of current track)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set strSNGName to (get name of current track)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set strSNGAlbum to (get album of current track)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set strSNGTrackNumber to (get track number of current track)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set strSNGDuration to (get duration of current track as integer)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set iTsCurDBID to iTsNewDBID<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end tell<br />&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false<br />&nbsp;&nbsp;&nbsp; end if<br />end fuisiTunesNUD </em>
<p><em>to SmartSay(strToSay)<br />&nbsp;&nbsp;&nbsp; set isiTPing to false<br />&nbsp;&nbsp;&nbsp; if fniTunesisActive() is true then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tell application "iTunes" to if player state is playing then set isiTPing to true<br />&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp; if isiTPing is true then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tell application "iTunes"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set iTsORSoundVolume to sound volume<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set timeTry to 0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; repeat while timeTry < 10<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set timeTry to timeTry + 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set sound volume to iTsORSoundVolume *<br />
 (15 - timeTry) / 15<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay 0.1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end repeat<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end tell<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; repeat with intSti from 1 to (count strToSay)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "" &amp; (item intSti of strToSay)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if intSti < (count strToSay) then delay 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end repeat<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tell application "iTunes"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set timeTry to 10<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; repeat while timeTry > 0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set timeTry to timeTry - 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set sound volume to iTsORSoundVolume * (15 - timeTry) / 15<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay 0.1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end repeat<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end tell<br />&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "" &amp; strToSay<br />&nbsp;&nbsp;&nbsp; end if<br />end SmartSay </em>
<p><em>to fnMusic(isOnline)<br />&nbsp;&nbsp;&nbsp; if fuisiTunesNUD() is true then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SmartSay(&#123;strSNGName, strSNGArtist&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if isOnline is true then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (length of LastfmUsername) > 0 and (length of LastfmPassword) > 0 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do shell script "curl --connect-timeout 30 "</em><a href="http://lastfmstats.livefrombmore.com/universalscrobbler/scrobble.php?submissionType=track""><em>http://lastfmstats.livefrombmore.com/universalscrobbler/scrobble.php?submissionType=track"</em></a><em> &amp; "&amp;username=" &amp; LastfmUsername &amp; "&amp;password=" &amp; LastfmPassword &amp; "&amp;artist=" &amp; fnURLec(strSNGArtist) &amp; "&amp;track=" &amp; fnURLec(strSNGName) &amp; "&amp;album=" &amp; fnURLec(strSNGAlbum) &amp; "&amp;number=" &amp; strSNGTrackNumber &amp; "&amp;duration=" &amp; strSNGDuration &amp; """<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; on error<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SmartSay(&#123;"Scrobbling Failed"&#125;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnTwitter("I am listening to #" &amp; strSNGName &amp; " by #" &amp; strSNGArtist &amp; " in album #" &amp; strSNGAlbum &amp; ". // " &amp; (current date), false)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br />&nbsp;&nbsp;&nbsp; end if<br />end fnMusic</em></p></p></p></blockquote>  </div></p>
