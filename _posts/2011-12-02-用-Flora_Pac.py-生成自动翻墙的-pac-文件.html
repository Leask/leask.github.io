---
layout: post
status: publish
published: true
title: "用 Flora_Pac.py 生成自动翻墙的 pac 文件"
author: Leask




author_login: leask
author_email: i@leaskh.com
author_url: https://leaskh.com
wordpress_id: 1905
wordpress_url: https://leaskh.com/?p=1905
date: '2011-12-02 12:20:07 +0800'
date_gmt: '2011-12-02 04:20:07 +0800'
categories:

tags: []
comments:
- id: 1221
  author: "用 Flora_Pac.py 生成自动翻墙的 pac 文件 &laquo; 细节的力量"
  author_email: ''
  author_url: http://xijie.wordpress.com/2011/12/04/%e7%94%a8-flora_pac-py-%e7%94%9f%e6%88%90%e8%87%aa%e5%8a%a8%e7%bf%bb%e5%a2%99%e7%9a%84-pac-%e6%96%87%e4%bb%b6/
  date: '2011-12-04 18:11:21 +0800'
  date_gmt: '2011-12-04 10:11:21 +0800'
  content: "[...] 原文：https://leaskh.com/2011/12/02/%e7%94%a8-flora_pac-py-%e7%94%9f%e6%88%90%e8%87%aa%e5%8a%a8%e7%bf%b...
    [...]"
- id: 1222
  author: "用 Flora_Pac.py 生成自动翻墙的 pac 文件 &laquo; 细节的力量"
  author_email: ''
  author_url: http://xijie.wordpress.com/2011/12/04/%e7%94%a8-flora_pac-py-%e7%94%9f%e6%88%90%e8%87%aa%e5%8a%a8%e7%bf%bb%e5%a2%99%e7%9a%84-pac-%e6%96%87%e4%bb%b6/
  date: '2011-12-04 18:11:24 +0800'
  date_gmt: '2011-12-04 10:11:24 +0800'
  content: "[...] 原文：https://leaskh.com/2011/12/02/%e7%94%a8-flora_pac-py-%e7%94%9f%e6%88%90%e8%87%aa%e5%8a%a8%e7%bf%b...
    [...]"
- id: 1899
  author: yeahsky
  author_email: reg@redren.com
  author_url: http://blog.redren.com
  date: '2012-03-14 09:09:17 +0800'
  date_gmt: '2012-03-14 01:09:17 +0800'
  content: "感谢楼主，果然是好东西。非常好用。"
- id: 2168
  author: "智能翻墙Pac文件 &ndash; Flora_Pac | Stephen King 的博客"
  author_email: ''
  author_url: http://stephenking66.tk/archives/928
  date: '2012-05-10 14:14:23 +0800'
  date_gmt: '2012-05-10 06:14:23 +0800'
  content: "[...] 想了解Flora_Pac文件原理的，请看《Flora_Pac.py 生成自动翻墙的 pac 文件》。 [...]"
- id: 2172
  author: "智能翻墙Pac文件- Flora_Pac &laquo; Qiantongshun&#039;s Blog"
  author_email: ''
  author_url: http://qiantongshun.wordpress.com/2012/05/11/%e6%99%ba%e8%83%bd%e7%bf%bb%e5%a2%99pac%e6%96%87%e4%bb%b6-flora_pac/
  date: '2012-05-11 13:28:05 +0800'
  date_gmt: '2012-05-11 05:28:05 +0800'
  content: "[...] 想了解Flora_Pac文件原理的，请看《Flora_Pac.py 生成自动翻墙的 pac 文件》。 [...]"
- id: 2176
  author: "智能翻墙Pac文件- Flora_Pac &laquo; 细节的力量"
  author_email: ''
  author_url: http://xijie.wordpress.com/2012/05/11/%e6%99%ba%e8%83%bd%e7%bf%bb%e5%a2%99pac%e6%96%87%e4%bb%b6-flora_pac/
  date: '2012-05-12 11:56:44 +0800'
  date_gmt: '2012-05-12 03:56:44 +0800'
  content: "[...] 想了解Flora_Pac文件原理的，请看《Flora_Pac.py 生成自动翻墙的 pac 文件》。 [...]"
- id: 2227
  author: fhxu
  author_email: sw7712@gmail.com
  author_url: ''
  date: '2012-05-23 15:38:47 +0800'
  date_gmt: '2012-05-23 07:38:47 +0800'
  content: "好东西，感谢分享！"
- id: 2345
  author: "乂按"
  author_email: lomyr.jo@gmail.com
  author_url: http://www.logcg.com
  date: '2012-07-04 21:15:31 +0800'
  date_gmt: '2012-07-04 13:15:31 +0800'
  content: "博主你好，请问如何解决内网问题？似乎路由的192.168.1.1也被列入了国外ip!!肿么改才好!!？因为这样的话就不能打开路由的管理界面!!呃"
- id: 2552
  author: dongxi8
  author_email: dongxi8@gmail.com
  author_url: ''
  date: '2012-08-04 15:45:15 +0800'
  date_gmt: '2012-08-04 07:45:15 +0800'
  content: "想要在flora_pac.pac里屏蔽掉路由器的ip地址192.168.x.x，该怎么修改pac文件啊"
- id: 3899
  author: Leask
  author_email: i@leaskh.com
  author_url: https://leaskh.com
  date: '2012-11-22 23:52:42 +0800'
  date_gmt: '2012-11-22 15:52:42 +0800'
  content: "代码已经更新了，去 github 更新一份就好了。"
- id: 3900
  author: Leask
  author_email: i@leaskh.com
  author_url: https://leaskh.com
  date: '2012-11-22 23:53:27 +0800'
  date_gmt: '2012-11-22 15:53:27 +0800'
  content: "代码已经更新了，去 github 更新一份就好了。 :)"
- id: 4376
  author: any
  author_email: anyfc1217@gamil.com
  author_url: ''
  date: '2012-12-24 22:55:13 +0800'
  date_gmt: '2012-12-24 14:55:13 +0800'
  content: |-
    纯小白来求助：
    win8系统
    已经安装了Python3.3
    已在github上下载到 flora_pac，并重命名为 flora_pac.py
    双击flora_pac.py后，命令行窗口一闪而过，什么都没有留下
    请问还缺少了什么，或者是哪里错了？
- id: 4383
  author: any
  author_email: anyfc1217@gamil.com
  author_url: ''
  date: '2012-12-25 10:54:25 +0800'
  date_gmt: '2012-12-25 02:54:25 +0800'
  content: "原来是不支持3.X的。。。\uFEFF"
- id: 4596
  author: goomoon
  author_email: laughingchs@gmail.com
  author_url: ''
  date: '2013-01-10 10:53:59 +0800'
  date_gmt: '2013-01-10 02:53:59 +0800'
  content: "楼主，现在碰到一个问题；在公司有很多应用是内部应用，一访问就会报如下异常\r\nPython Urlfetch Error: 'GET'\r\nDNSLookupFailedError('DNS
    lookup failed for URL: http://xxx.xxx-inc.com/',), deadline=60\r\n\r\n这个问题如何解决。\r\n\r\n另外，10.*.*.*网段和172.16.*.*--172.31.*.*网段都是局域网网段，应该加入到国内列表里面"
- id: 4613
  author: kumkee
  author_email: kumkeejjl@gmail.com
  author_url: ''
  date: '2013-01-10 23:00:30 +0800'
  date_gmt: '2013-01-10 15:00:30 +0800'
  content: "支持https路由吗？如goagent"
- id: 4645
  author: Leask
  author_email: i@leaskh.com
  author_url: https://leaskh.com
  date: '2013-01-12 19:02:54 +0800'
  date_gmt: '2013-01-12 11:02:54 +0800'
  content: Sorry 还不支持python3
- id: 5269
  author: adolink
  author_email: 15675214@qq.com
  author_url: ''
  date: '2013-02-11 14:07:05 +0800'
  date_gmt: '2013-02-11 06:07:05 +0800'
  content: "内网ip段不全啊 A类的10.0.0.0到10.255.255.255   B类的172.16.0.0到172.31.255.255，还有224之后的广播段"
- id: 6056
  author: "苦咖啡 &raquo; 用 Flora_Pac.py 生成自动翻墙的 pac 文件"
  author_email: ''
  author_url: http://www.kukefei.me/?p=1277
  date: '2013-03-27 12:38:50 +0800'
  date_gmt: '2013-03-27 04:38:50 +0800'
  content: "[...] 官方博客：点击进入 [...]"
- id: 6075
  author: Leask
  author_email: i@leaskh.com
  author_url: https://leaskh.com
  date: '2013-03-29 02:13:55 +0800'
  date_gmt: '2013-03-28 18:13:55 +0800'
  content: "将会逐渐完善。不好意思啊，业余项目，平日要工作，维护时间不多。谢谢您的宝贵意见。"
- id: 6076
  author: Leask
  author_email: i@leaskh.com
  author_url: https://leaskh.com
  date: '2013-03-29 02:14:28 +0800'
  date_gmt: '2013-03-28 18:14:28 +0800'
  content: "支持。"
- id: 6077
  author: Leask
  author_email: i@leaskh.com
  author_url: https://leaskh.com
  date: '2013-03-29 02:15:29 +0800'
  date_gmt: '2013-03-28 18:15:29 +0800'
  content: "哈哈，最近有时间会迁移到 py 3 上的。"
- id: 6084
  author: Leask
  author_email: i@leaskh.com
  author_url: https://leaskh.com
  date: '2013-03-29 02:23:55 +0800'
  date_gmt: '2013-03-28 18:23:55 +0800'
  content: |-
    下一个版本会支持python3，支持更完善的内网段，并且支持例外域名作为生成参数。

    谢谢支持。
- id: 6238
  author: scara
  author_email: scarangel93@gmail.com
  author_url: http://gravatar.com/schu737898735
  date: '2013-06-05 23:21:44 +0800'
  date_gmt: '2013-06-05 15:21:44 +0800'
  content: "谢谢博主，这个挺直接的，干净利落。"
- id: 6259
  author: wenlong1423
  author_email: y1423027101@gmail.com
  author_url: http://wenlong1423.wordpress.com
  date: '2013-06-23 23:30:38 +0800'
  date_gmt: '2013-06-23 15:30:38 +0800'
  content: "呃。。。。。https://zh.greatfire.org/ 打不开，chrome表示DNS解析失败，dnsResolve函数是不是运行失败还是什么呢？联通的DNS没返回结果，所以浏览器不知道怎么办了么？"
- id: 6260
  author: wenlong1423
  author_email: y1423027101@gmail.com
  author_url: http://wenlong1423.wordpress.com
  date: '2013-06-23 23:40:29 +0800'
  date_gmt: '2013-06-23 15:40:29 +0800'
  content: "var strIp = dnsResolve(host);\r\n    if (!strIp) {\r\n        return PROXY;\r\n
    \   }\r\nDNS无法解析时用直链？\r\n用意何在？不理解？\r\n希望博主指教"
- id: 6291
  author: ask
  author_email: ask@12.com
  author_url: ''
  date: '2013-07-24 18:35:57 +0800'
  date_gmt: '2013-07-24 10:35:57 +0800'
  content: "好像还是不行，能打开twitter 但是facebook和youtube打不开，是不是dns污染 呢？\r\n我用的socks加密后中转的http代理"
- id: 6292
  author: EdiTurn
  author_email: yyxstter@gmail.com
  author_url: http://gravatar.com/editurn
  date: '2013-07-30 00:00:10 +0800'
  date_gmt: '2013-07-29 16:00:10 +0800'
  content: "博主你好，很抱歉作为一个伸手党来索取功能。\r\n能否考虑实现将其转换成一个在线规则列表，以便实现在 Chrome 的 Proxy SwitchySharp
    中自动更新规则并能够更方便的切换所需的代理。即类似于 gfwlist。"
- id: 6296
  author: Leask
  author_email: i@leaskh.com
  author_url: https://leaskh.com
  date: '2013-08-02 12:16:38 +0800'
  date_gmt: '2013-08-02 04:16:38 +0800'
  content: "什么平台？上游是什么代理？"
- id: 6297
  author: Leask
  author_email: i@leaskh.com
  author_url: https://leaskh.com
  date: '2013-08-02 12:17:24 +0800'
  date_gmt: '2013-08-02 04:17:24 +0800'
  content: "有相关计划，谢谢你的意见。：）"
- id: 6299
  author: ask
  author_email: ask@12.com
  author_url: ''
  date: '2013-08-05 05:37:04 +0800'
  date_gmt: '2013-08-04 21:37:04 +0800'
  content: "对squid提供了一个加密的dns查询后，问题解决了。 估计原因是squid查询到错误的ip。感谢楼主的分享"
- id: 6323
  author: Leask
  author_email: i@leaskh.com
  author_url: https://leaskh.com
  date: '2013-10-31 00:11:01 +0800'
  date_gmt: '2013-10-30 16:11:01 +0800'
  content: "今天实现了一下类似的功能，不知道是否如你所愿，详情可参见： https://leaskh.com/2013/10/30/测试为-Flora_Pac-提供-HTTP-host/"
- id: 6329
  author: dgiraffe
  author_email: arsegiraffe-pl@yahoo.com
  author_url: ''
  date: '2013-11-24 05:25:24 +0800'
  date_gmt: '2013-11-23 21:25:24 +0800'
  content: "博主你好，我是一個普通用戶，對技術方面並不了解，可能問題會比較小白了點，見笑了。\r\n用了你的 flora_pac 後確實是相當的舒服，但是有個問題，在之前的版本中，生成的
    pac 文件會出現打開台灣 IP 沒有走代理的情況，顯示鏈接被重置。然後今天在你的 GitHub 主頁下載的新的 flora_pac 文件，生成後的 pac
    文件卻會導致全局走代理，沒有區分國外國內 IP。我的使用環境是 Firefox+FoxyProxy"
- id: 6330
  author: Leask
  author_email: i@leaskh.com
  author_url: https://leaskh.com
  date: '2013-11-24 18:43:45 +0800'
  date_gmt: '2013-11-24 10:43:45 +0800'
  content: "前几天有个朋友贡献了一段优化代码，我没有完全测试就合并了，导致全局走代理了。对不起大家。问题已经修正了。台湾站点的问题我可以再调试一下，请列出有问题的站点的网址，谢谢你！"
- id: 6331
  author: dgiraffe
  author_email: arsegiraffe-pl@yahoo.com
  author_url: ''
  date: '2013-11-24 21:09:32 +0800'
  date_gmt: '2013-11-24 13:09:32 +0800'
  content: "你好，比如這個網址 http://www.pixnet.net/ 就沒有走代理"
- id: 17563
  author: benosn
  author_email: 1275381@qq.com
  author_url: ''
  date: '2015-04-22 03:04:55 +0800'
  date_gmt: '2015-04-21 19:04:55 +0800'
  content: "用vpn怎么翻墙，加设了，但还是上不了www.youtube.com的。"
- id: 17564
  author: Leask
  author_email: i@leaskh.com
  author_url: https://leaskh.com
  date: '2015-04-22 11:06:19 +0800'
  date_gmt: '2015-04-22 03:06:19 +0800'
  content: "什么意思？你用什么VPN？"
- id: 17565
  author: Leask
  author_email: i@leaskh.com
  author_url: https://leaskh.com
  date: '2015-04-23 22:02:06 +0800'
  date_gmt: '2015-04-23 14:02:06 +0800'
  content: VPN 不需要 Flora Pac 的，Flora Pac 一般和代理一起工作。VPN 找专用的路由表才行。
- id: 17618
  author: hnboy2005
  author_email: hnboy2005@gmail.com
  author_url: http://gravatar.com/hnboy2005
  date: '2015-08-26 16:10:13 +0800'
  date_gmt: '2015-08-26 08:10:13 +0800'
  content: "你好, \r\n这个pac挺好的,我想咨询个问题,不知道可否解答一下:\r\nDnsResolve(host) 这个方法dns解析时, 走的是本地解析还是远程解析?\r\n我知道浏览器如果设置了HTTP代理的话都是走远程解析的.\r\n但是在PAC文件里的DnsResolve就不太清楚是本地还是远程解析了.\r\n谢谢!"
---
<p>源于人们对自由的向往，翻墙技术已渐趋成熟。愿意花点钱，购买海外 VPN 和 ssh 主机用于自由获取信息是目前比较有效的手段。如我之前文章中提及，这两种方式都有需要筛选出那些网站在墙外，那些网站在墙内，以较节约、高速的方式访问网络。八仙过海，各显神通，不少帮助人们解决这一问题，降低翻墙门槛的小项目出现了。较具代表性的有&nbsp;chnroutes(<a href="http://code.google.com/p/chnroutes/">http://code.google.com/p/chnroutes/</a>) 项目和&nbsp;autoproxy-gfwlist(<a href="http://code.google.com/p/autoproxy-gfwlist/">http://code.google.com/p/autoproxy-gfwlist/</a>) 项目。前者修改路由表，配合各种 VPN 使用，后者可以配合 AutoProxy for Firefox(<a href="https://addons.mozilla.org/firefox/addon/11009">https://addons.mozilla.org/firefox/addon/11009</a>) 或导出(<a href="https://autoproxy2pac.appspot.com/">https://autoproxy2pac.appspot.com/</a>)为 pac 文件，配合各种代理服务器，包括 ssh -D 使用。他们的原理稍有差异，chnroutes 只区分国内外 IP 段，让国外地址全部走翻墙路线，autoproxy-gfwlist 项目则精确记录着那些网站被墙。</p>
<p>我以往喜欢 ssh -D 生成 SOCKS 代理后，搭配自己的 pac 文件翻墙。最近由于各种原因转到了 VPN 阵营。感觉 VPN 搭配&nbsp;chnroutes 的确很舒服，不用再关心那些网站被墙，不会因为 gfwlist 更新延迟而影响访问。于是我在想，有没有办法让使用 ssh -D 或者其他翻墙代理的用户能和使用 VPN 的用户那样省心呢？于是我站在巨人的肩膀上，基于&nbsp;chnroutes 项目，结合 pac 文件的 dnsResolve() 和&nbsp;isInNet() 函数，开发了&nbsp;Flora_Pac 这个小项目。</p>
<p>Flora_Pac 使用 Python 开发，能自动抓取&nbsp;<a href="http://apnic.net">apnic.net</a> 的 IP 数据，找出所有国内的 IP 地址段，生成能让浏览器自动判断国内外 IP 地址的 pac 文件，让代理用户有等价于 VPN + chnroutes&nbsp;的翻墙体验。Flora_Pac 使用十分简单，兼容各种平台：</p>
<pre>####### 获得帮助:<br />
$ python flora_pac.py -h<br />
usage: flora_pac.py [-h] [-x [PROXY]]<br />
Generate proxy auto-config rules.<br />
optional arguments:<br />
  -h, --help            show this help message and exit<br />
  -x [PROXY], --proxy [PROXY]<br />
                        Proxy Server, examples:<br />
                            SOCKS 127.0.0.1:8964;<br />
                            SOCKS5 127.0.0.1:8964;<br />
                            PROXY 127.0.0.1:8964</p>
<p>####### 生成 pac 文件，国外 IP 通过代理 SOCKS 代理 127.0.0.1:8964 访问:<br />
$ python flora_pac.py -x 'SOCKS 127.0.0.1:8964'<br />
Fetching data from apnic.net, it might take a few minutes, please wait...<br />
Rules: 3460 items.<br />
Usage: Use the newly created flora_pac.pac as your web browser's automatic proxy configuration (.pac) file.</p>
<p>####### 生成 pac 文件，国外 IP 通过代理 HTTP 代理 127.0.0.1:8964 访问:<br />
$ python flora_pac.py -x 'PROXY 127.0.0.1:8964'<br />
Fetching data from apnic.net, it might take a few minutes, please wait...<br />
Rules: 3460 items.<br />
Usage: Use the newly created flora_pac.pac as your web browser's automatic proxy configuration (.pac) file.</pre><br />
程序跑完后，就会在当前目录产生 flora_pac.pac 文件，把它设为浏览器或系统代理设置的 pac 文件即可。</p>
<p>项目代码我放在 github 上开源了：<a href="https://github.com/Leask/Flora_Pac">https://github.com/Leask/Flora_Pac</a>，其中&nbsp;fetch_ip_data 函数 fork 自 chnroutes 项目。</p>
<p>不方便上 github 的朋友，直接复制以下代码保存为 flora_pac.py 就可以跑了：</p>
<pre>#!/usr/bin/env python<br />
#<br />
# Flora_Pac by @leaskh<br />
# www.leaskh.com, i@leaskh.com<br />
#<br />
# based on chnroutes project (by Numb.Majority@gmail.com)<br />
#</p>
<p>import re<br />
import urllib2<br />
import argparse<br />
import math</p>
<p>def generate_pac(proxy):<br />
    results  = fetch_ip_data()<br />
    pacfile  = 'flora_pac.pac'<br />
    rfile    = open(pacfile, 'w')<br />
    strLines = (<br />
        "// Flora_Pac by @leaskh"<br />
        "\n// www.leaskh.com, i@leaskh.com"<br />
        "\n"<br />
        "\nfunction FindProxyForURL(url, host)"<br />
        "\n{"<br />
        "\n"<br />
        "\n    var list = ["<br />
    )<br />
    intLines = 0<br />
    for ip,mask,_ in results:<br />
        if intLines > 0:<br />
            strLines = strLines + ','<br />
        intLines = intLines + 1<br />
        strLines = strLines + "\n        ['%s', '%s']"%(ip, mask)<br />
    strLines = strLines + (<br />
        "\n    ];"<br />
        "\n"<br />
        "\n    var ip = dnsResolve(host);"<br />
        "\n"<br />
        "\n    for (var i in list) {"<br />
        "\n        if (isInNet(ip, list[i][0], list[i][1])) {"<br />
        "\n            return 'DIRECT';"<br />
        "\n        }"<br />
        "\n    }"<br />
        "\n"<br />
        "\n    return '%s';"<br />
        "\n"<br />
        "\n}"<br />
        "\n"%(proxy)<br />
    )<br />
    rfile.write(strLines)<br />
    rfile.close()<br />
    print ("Rules: %d items.\n"<br />
           "Usage: Use the newly created %s as your web browser's automatic "<br />
           "proxy configuration (.pac) file."%(intLines, pacfile))</p>
<p>def fetch_ip_data():<br />
    #fetch data from apnic<br />
    print "Fetching data from apnic.net, it might take a few minutes, please wait..."<br />
    url=r'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest'<br />
    data=urllib2.urlopen(url).read()</p>
<p>    cnregex=re.compile(r'apnic\|cn\|ipv4\|[0-9\.]+\|[0-9]+\|[0-9]+\|a.*',re.IGNORECASE)<br />
    cndata=cnregex.findall(data)</p>
<p>    results=[]</p>
<p>    for item in cndata:<br />
        unit_items=item.split('|')<br />
        starting_ip=unit_items[3]<br />
        num_ip=int(unit_items[4])</p>
<p>        imask=0xffffffff^(num_ip-1)<br />
        #convert to string<br />
        imask=hex(imask)[2:]<br />
        mask=[0]*4<br />
        mask[0]=imask[0:2]<br />
        mask[1]=imask[2:4]<br />
        mask[2]=imask[4:6]<br />
        mask[3]=imask[6:8]</p>
<p>        #convert str to int<br />
        mask=[ int(i,16 ) for i in mask]<br />
        mask="%d.%d.%d.%d"%tuple(mask)</p>
<p>        #mask in *nix format<br />
        mask2=32-int(math.log(num_ip,2))</p>
<p>        results.append((starting_ip,mask,mask2))</p>
<p>    return results</p>
<p>if __name__=='__main__':<br />
    parser=argparse.ArgumentParser(description="Generate proxy auto-config rules.")<br />
    parser.add_argument('-x', '--proxy',<br />
                        dest = 'proxy',<br />
                        default = 'SOCKS 127.0.0.1:8964',<br />
                        nargs = '?',<br />
                        help = "Proxy Server, examples: "<br />
                               "SOCKS 127.0.0.1:8964; "<br />
                               "SOCKS5 127.0.0.1:8964; "<br />
                               "PROXY 127.0.0.1:8964")</p>
<p>    args = parser.parse_args()</p>
<p>    generate_pac(args.proxy)</pre><br />
我想，应该过不了多久就要解放了。期待着有那么一天：我们能一起呼吸自由的空气，我们不再需要折腾各种翻墙玩意。那时，生活应该会更美好一些吧。</p>
